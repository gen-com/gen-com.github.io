---
layout: posts
title: "Process Memory"
date: 2024-07-16 13:00:00 +0900
---

프로세스의 메모리는 어떻게 관리되는지 알아봅시다.

## 프로세스 메모리 관리 모델

iOS 환경에서 프로세스 메모리 구조는 일반적으로 다음과 같은 세그먼트로 구성됩니다.

- 텍스트 세그먼트
- 데이터 세그먼트
- 힙 (Heap)
- 스택 (Stack)

### 메모리 레이아웃

대략적인 그림으로 나타내면 다음과 같습니다.

```text
+--------------------+
| Stack              | (성장 방향: 높은 주소 -> 낮은 주소)
+--------------------+
|        ...         |
+--------------------+
| Heap               | (성장 방향: 낮은 주소 -> 높은 주소)
+--------------------+
|        ...         |
+--------------------+
| BSS                |
+--------------------+
| Initialized Data   |
+--------------------+
| Text Segment       |
+--------------------+
| Program Code       | (낮은 주소)
+--------------------+
```


### 텍스트 세그먼트 (Text Segment)

실행 가능한 코드가 저장되는 영역입니다.

읽기 전용이며, 프로그램의 명령어들이 포함됩니다.

CPU가 실행할 명령어들이 여기에 위치합니다.

### 데이터 세그먼트 (Data Segment)

전역 변수와 정적 변수가 저장되는 영역입니다.

초기화된 데이터와 초기화되지 않은 데이터로 나뉩니다.

초기화된 데이터 영역 (Initialized Data Segment): 명시적으로 초기화된 전역 변수 및 정적 변수가 저장됩니다.

초기화되지 않은 데이터 영역 (Uninitialized Data Segment, BSS): 초기값이 없는 전역 변수 및 정적 변수가 저장됩니다.

### 힙 (Heap)

동적 메모리 할당을 위해 사용되는 영역입니다.

런타임 시 malloc이나 calloc 같은 함수 호출로 메모리가 할당되며, 필요에 따라 크기가 동적으로 증가하거나 감소합니다.

힙 메모리는 프로그램 실행 중에 동적으로 할당 및 해제됩니다.

### 힙 영역 관리

- 연속된 메모리 할당 피하기

    크기가 다른 메모리 블록들을 연속적으로 할당하지 않도록 합니다. 크기가 다른 블록이 번갈아가며 할당되고 해제되면 내부 단편화가 발생할 수 있습니다.
    
- 메모리 요청 크기 조정

    비슷한 크기의 메모리 요청을 묶어서 할당하거나, 크기를 맞춰 할당합니다. 예를 들어, 64바이트, 128바이트, 256바이트 등 고정된 크기로 메모리를
    할당하면 단편화를 줄일 수 있습니다.
    
- Garbage Collection

    메모리 관리가 어려운 상황에서는 자동 메모리 관리를 제공하는 Garbage Collection을 사용합니다. 이는 메모리 누수를 방지하고 단편화를 줄이는 데 
    도움이 될 수 있습니다.
    
    Swift에서는 [ARC](https://bbiguduk.gitbook.io/swift/language-guide-1/automatic-reference-counting) 방식을 사용합니다.

### 스택 (Stack)

함수 호출 시 지역 변수와 매개변수가 저장되는 영역입니다.

함수 호출 시 스택 프레임이 생성되며, 함수가 종료되면 스택 프레임이 해제됩니다.

스택은 LIFO (Last In, First Out) 구조로 동작합니다.

### 스택 영역 관리

- 스택 프레임 (Stack Frame)

    각 함수 호출마다 하나의 스택 프레임이 생성됩니다. 스택 프레임은 함수의 실행 상태를 저장하는 데 사용됩니다.
    
    스택 프레임에는 함수의 매개변수, 지역 변수, 리턴 주소, 이전 프레임 포인터 등이 저장됩니다.

- 함수 호출 (Function Call):

    함수가 호출되면, 호출된 함수의 매개변수와 리턴 주소가 스택에 저장됩니다.
    
    현재 함수의 프레임 포인터(이전 스택 프레임의 시작 주소)를 저장한 후, 새로운 프레임 포인터를 설정합니다.
    
    함수의 지역 변수를 위한 공간이 스택에 할당됩니다.

- 함수 반환 (Function Return):

    함수가 반환되면, 현재 스택 프레임이 제거됩니다.
    
    스택 포인터를 이전 스택 프레임의 시작 주소로 되돌립니다.
    
    리턴 주소를 사용하여 호출된 함수로 돌아갑니다.

- 스택 포인터 (Stack Pointer, SP) 및 프레임 포인터 (Frame Pointer, FP):

    스택 포인터(SP)는 현재 스택의 최상단을 가리킵니다.
    
    프레임 포인터(FP)는 현재 함수의 스택 프레임의 시작 위치를 가리킵니다.
    
    함수 호출 시 SP와 FP가 업데이트됩니다.

## 가상 메모리

가상 메모리라는 것은 프로세스 전체가 메모리 내에 올라오지 않더라도 실행이 가능하도록 하는 기법입니다.

주요 장점은 **사용자 프로그램이 물리 메모리보다 커져도 된다**는 것입니다.

가상 메모리는 물리 메모리로부터 프로그래머 관점의 논리 메모리를 분리해 메인 메모리를 균일한 크기의 저장 공간으로 구성된 엄청나게 큰 배열로 추상화 시켜줍니다.

### 가상 메모리의 동작 과정

1. 각 프로세스는 자신만의 페이지 테이블을 가지며, 가상 주소를 물리 주소로 매핑하는 정보를 저장합니다.

2. 프로세스가 메모리에 없는 페이지에 접근하면 페이지 폴트가 발생하고, 운영체제는 디스크에서 해당 페이지를 로드합니다.

3. 물리 메모리가 부족할 때, 사용하지 않는 페이지를 스왑 공간으로 이동시켜 메모리를 확보합니다.
